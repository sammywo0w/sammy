from flask import Flask, request, send_file, jsonify
from pptx import Presentation
import os
import uuid
import re

app = Flask(__name__)

# Универсальная функция замены плейсхолдеров
def replace_placeholders(prs, data):
    for slide in prs.slides:
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue
            for paragraph in shape.text_frame.paragraphs:
                for key in re.findall(r"<(.*?)>", paragraph.text):
                    key_lower = key.lower()
                    parts = key_lower.split()
                    if len(parts) == 0:
                        continue
                    base_key = parts[0]  # например: "target"
                    try:
                        index = int(parts[-1]) - 1  # например: "3" → 2
                    except:
                        index = None

                    value = ""
                    if base_key in data:
                        if isinstance(data[base_key], list) and index is not None:
                            if index < len(data[base_key]):
                                value = data[base_key][index]
                        elif index is None:
                            value = str(data[base_key])

                    # Заменяем или удаляем плейсхолдер
                    paragraph.text = paragraph.text.replace(f"<{key}>", value)

@app.route('/generate', methods=['POST'])
def generate_pptx():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON"}), 400

    # Загружаем шаблон
    prs = Presentation("11Business Model Template.pptx")

    # Заменяем плейсхолдеры
    replace_placeholders(prs, data)

    # Сохраняем и отдаём
    filename = f"{uuid.uuid4().hex}.pptx"
    filepath = os.path.join("/tmp", filename)
    prs.save(filepath)
    return send_file(filepath, as_attachment=True, download_name="business_model_filled.pptx")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5000)))


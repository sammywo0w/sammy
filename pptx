from flask import Flask, request, send_file, jsonify
from pptx import Presentation
import os
import uuid
import re

app = Flask(__name__)

def replace_placeholders(prs, data):
    # соответствие ключей JSON → базовые плейсхолдеры
    key_map = {
        "target_customers": "target_customer",
        "value_proposition": "value_proposition",
        "revenue_drivers": "revenue_driver",
        "cost_drivers": "cost_driver",
        "customer_channels": "customer_channel",
        "resources": "resource",
        "offering": "offering",
        "customer_relationship": "customer_relation",
        "partners": "partner",
        "activities": "activity",
        "model_name": "business_model_name"
    }

    # нормализация ключей
    normalized_data = {}
    for k, v in data.items():
        mapped_key = key_map.get(k, k)
        normalized_data[mapped_key] = v

    # замена по шаблону
    for slide in prs.slides:
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue

            for paragraph in shape.text_frame.paragraphs:
                for run in paragraph.runs:
                    matches = re.findall(r"<(.*?)>", run.text)
                    new_text = run.text

                    for match in matches:
                        placeholder_key = match.lower()
                        parts = placeholder_key.split()
                        if not parts:
                            continue

                        base_key = parts[0]  # например: "target_customer"
                        try:
                            index = int(parts[-1]) - 1  # "3" → 2
                        except:
                            index = None

                        value = ""
                        if base_key in normalized_data:
                            source = normalized_data[base_key]
                            if isinstance(source, list) and index is not None and index < len(source):
                                value = str(source[index])
                            elif isinstance(source, str) and index is None:
                                value = source

                        new_text = new_text.replace(f"<{match}>", value)

                    # удаление оставшихся незаполненных плейсхолдеров
                    new_text = re.sub(r"<.*?>", "", new_text)
                    run.text = new_text

@app.route('/generate', methods=['POST'])
def generate_pptx():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON"}), 400

    prs = Presentation("11Business Model Template.pptx")
    replace_placeholders(prs, data)

    filename = f"{uuid.uuid4().hex}.pptx"
    filepath = os.path.join("/tmp", filename)
    prs.save(filepath)

    return send_file(filepath, as_attachment=True, download_name="business_model_filled.pptx")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5000)))

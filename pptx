from flask import Flask, request, send_file, jsonify
from pptx import Presentation
import os
import uuid

app = Flask(__name__)

@app.route('/generate', methods=['POST'])
def generate_pptx():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON"}), 400

    # Загрузка шаблона
    template_path = "11Business Model Template.pptx"
    prs = Presentation(template_path)

    # Карта замены плейсхолдеров
    key_map = {
        "target_customers": "Target Customer",
        "value_proposition": "Value Proposition",
        "cost_drivers": "Cost driver",
        "revenue_drivers": "Revenue driver",
        "customer_channels": "Customer Channel",
        "resources": "Resource",
        "offering": "Offering",
        "customer_relationship": "Customer Relation",
        "partners": "Partner",
        "activities": "Activity",
        "model_name": "Business Model Name"
    }

    def replace_text(slide, placeholder, replacements):
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue
            for paragraph in shape.text_frame.paragraphs:
                for run in paragraph.runs:
                    if f"<{placeholder}>" in run.text:
                        for i, item in enumerate(replacements, 1):
                            run.text = run.text.replace(f"<{placeholder} {i}>", item)
                        run.text = run.text.replace(f"<{placeholder}>", ", ".join(replacements))  # fallback

    def replace_title(slide, model_name):
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue
            if "<Business Model Name>" in shape.text:
                shape.text = shape.text.replace("<Business Model Name>", model_name)

    for slide in prs.slides:
        for field, base_key in key_map.items():
            value = data.get(field, [])
            if not isinstance(value, list):
                value = [value]
            if field == "model_name":
                replace_title(slide, value[0] if value else "")
            else:
                replace_text(slide, base_key, value)

    filename = f"{uuid.uuid4().hex}.pptx"
    filepath = os.path.join("/tmp", filename)
    prs.save(filepath)

    return send_file(filepath, as_attachment=True, download_name="business_model_canvas.pptx")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5000)))


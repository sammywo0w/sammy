from flask import Flask, request, send_file, jsonify
from pptx import Presentation
import os
import uuid

app = Flask(__name__)

def replace_text(placeholders, values, shape):
    if not isinstance(values, list):
        values = [values]
    for i, paragraph in enumerate(shape.text_frame.paragraphs):
        if i >= len(values):
            break
        for run in paragraph.runs:
            for placeholder in placeholders:
                if placeholder in run.text:
                    run.text = run.text.replace(placeholder, values[i])

@app.route('/generate', methods=['POST'])
def generate_pptx():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON"}), 400

    # Путь к шаблону в корне репозитория
    template_path = "Business Model Template.pptx"
    prs = Presentation(template_path)

    fields = {
        "<Business Model Name>": data.get("model_name", ""),
        "<Target Customer": data.get("target_customers", []),
        "<Customer Channel": data.get("customer_channels", []),
        "<Value Proposition": data.get("value_proposition", []),
        "<Activity": data.get("activities", []),
        "<Customer Relation": data.get("customer_relationship", []),
        "<Offering": data.get("offering", []),
        "<Partner": data.get("partners", []),
        "<Revenue driver": data.get("revenue_drivers", []),
        "<Cost driver": data.get("cost_drivers", []),
    }

    for slide in prs.slides:
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue
            text = shape.text
            for key, values in fields.items():
                if key in text:
                    if key == "<Business Model Name>":
                        replace_text([key], values, shape)
                    else:
                        replace_text([f"{key} {i+1}>" for i in range(3)], values, shape)

    filename = f"{uuid.uuid4().hex}.pptx"
    filepath = os.path.join("/tmp", filename)
    prs.save(filepath)
    return send_file(filepath, as_attachment=True, download_name="business_model_canvas.pptx")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5000)))

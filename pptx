from flask import Flask, request, send_file, jsonify
from pptx import Presentation
import os
import uuid
import re

app = Flask(__name__)

def replace_placeholders(prs, data):
    for slide in prs.slides:
        for shape in slide.shapes:
            if not shape.has_text_frame:
                continue

            for paragraph in shape.text_frame.paragraphs:
                for run in paragraph.runs:
                    matches = re.findall(r"<(.*?)>", run.text)
                    new_text = run.text

                    for match in matches:
                        key = match.lower()
                        parts = key.split()
                        if not parts:
                            continue

                        base = parts[0]
                        try:
                            index = int(parts[-1]) - 1
                        except:
                            index = None

                        value = ""
                        if base in data:
                            if isinstance(data[base], list) and index is not None:
                                if index < len(data[base]):
                                    value = str(data[base][index])
                            elif isinstance(data[base], str) and index is None:
                                value = data[base]

                        new_text = new_text.replace(f"<{match}>", value)

                    run.text = new_text

@app.route('/generate', methods=['POST'])
def generate_pptx():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Invalid or missing JSON"}), 400

    prs = Presentation("11Business Model Template.pptx")  # путь к шаблону

    replace_placeholders(prs, data)

    filename = f"{uuid.uuid4().hex}.pptx"
    filepath = os.path.join("/tmp", filename)
    prs.save(filepath)

    return send_file(filepath, as_attachment=True, download_name="business_model_filled.pptx")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 5000)))

